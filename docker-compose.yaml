services:

  # ----------------------------------------------------------------------------
  # Databases
  # ----------------------------------------------------------------------------
  order-db:
    image: postgres:18-alpine
    container_name: order-db
    environment:
      POSTGRES_DB: order_db
      POSTGRES_USER: order_db_user
      POSTGRES_PASSWORD: ${ORDER_DB_PASSWORD}
    ports:
      - "5433:5432"
    volumes:
      - order-data:/var/lib/postgresql/data
      # Optional: run SQL/SH scripts on first boot
      # - ./docker/initdb:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U order_db_user -d order_db"]
      interval: 10s
      timeout: 3s
      retries: 5

  warehouse-db:
    image: postgres:18-alpine
    container_name: warehouse-db
    environment:
      POSTGRES_DB: warehouse_db
      POSTGRES_USER: warehouse_db_user
      POSTGRES_PASSWORD: ${WAREHOUSE_DB_PASSWORD}
    ports:
      - "5434:5432"
    volumes:
      - warehouse-data:/var/lib/postgresql/data
      # Optional: run SQL/SH scripts on first boot
      # - ./docker/initdb:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U warehouse_db_user -d warehouse_db"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ----------------------------------------------------------------------------
  # NATS
  # ----------------------------------------------------------------------------
  nats:
    image: nats:2.10-alpine
    container_name: nats
    command: -js -m 8222 -DV
    ports:
      - "4222:4222" # client connections
      - "8222:8222" # monitoring UI
    healthcheck:
      # Try the monitoring endpoint; Alpine image has wget
      test: ["CMD-SHELL", "wget -qO- http://localhost:8222/varz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ----------------------------------------------------------------------------
  # Apps
  # ----------------------------------------------------------------------------
  order-service:
    # you already have a Dockerfile for the app
    build:
      context: ./ecom-order
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      DB_HOST: order-db
      DB_PORT: "5432"
      DB_USER: order_db_user
      DB_PASSWORD: ${ORDER_DB_PASSWORD}
      DB_DATABASE: order_db
      DB_SSL: "false"
      DB_DEBUG: "false"
    ports:
      - "3334:3333"
    depends_on:
      order-db:
        condition: service_healthy
      nats:
        condition: service_healthy
    # For hot-reload in dev (optional)
    volumes:
      - ./ecom-order:/app

  warehouse-service:
    build:
      context: ./ecom-warehouse
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      DB_HOST: warehouse-db
      DB_PORT: "5432"
      DB_USER: warehouse_db_user
      DB_PASSWORD: ${WAREHOUSE_DB_PASSWORD}
      DB_DATABASE: warehouse_db
      DB_SSL: "false"
      DB_DEBUG: "false"
    ports:
      - "3335:3333"
    depends_on:
      warehouse-db:
        condition: service_healthy
      nats:
        condition: service_healthy
    volumes:
      - ./ecom-warehouse:/app

# ----------------------------------------------------------------------------
# Volumes
# ---------------------------------------------------------------------------- 
volumes:
  order-data:
  warehouse-data:
